<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JIMI IoT Car Tracker Dashboard</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    h2 {
      text-align: center;
      margin: 10px 0;
    }

    #map {
      height: 65vh;
      width: 100%;
    }

    #controls {
      padding: 10px;
      background: #f8f8f8;
      border-bottom: 1px solid #ddd;
    }

    #filter {
      padding: 8px;
      width: 300px;
      font-size: 14px;
    }

    #table-container {
      padding: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f4f4f4;
    }

    .status {
      text-align: center;
      font-size: 18px;
    }
  </style>
</head>

<body>

<h2>üöó JIMI IoT Car Tracker Dashboard</h2>

<div id="controls">
  <input id="filter" placeholder="Search IMEI..." />
</div>

<div id="map"></div>

<div id="table-container">
  <h3>Last Known Locations</h3>
  <table id="deviceTable">
    <thead>
      <tr>
        <th>IMEI</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Speed (km/h)</th>
        <th>Timestamp (UTC)</th>
        <th>ERP</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  // -----------------------
  // Map setup
  // -----------------------
  const map = L.map("map").setView([0, 37], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18}).addTo(map);

  const markers = {};
  const trails = {};

  // -----------------------
  // Icons
  // -----------------------
  function getIcon(speed) {
    const color = speed > 0 ? "green" : "red";
    return L.icon({
      iconUrl: `/static/icons/car-${color}.png`,
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });
  }

  // -----------------------
  // Fetch + Render
  // -----------------------
  async function fetchDevices() {
    const res = await fetch("/api/devices");
    const devices = await res.json();
    updateMapAndTable(devices);
  }

  function updateMapAndTable(devices) {
    const tbody = document.querySelector("#deviceTable tbody");
    tbody.innerHTML = "";

    devices.forEach(device => {
      const {
        imei,
        lat,
        lon,
        speed,
        timestamp,
        erp_synced,
        trail
      } = device;

      if (lat == null || lon == null) return;

      // -----------------------
      // Table
      // -----------------------
      const row = document.createElement("tr");
      row.dataset.imei = imei;

      row.innerHTML = `
        <td>${imei}</td>
        <td>${lat.toFixed(5)}</td>
        <td>${lon.toFixed(5)}</td>
        <td>${speed}</td>
        <td>${timestamp}</td>
        <td class="status">${erp_synced ? "‚úÖ" : "‚ö†Ô∏è"}</td>
      `;

      tbody.appendChild(row);

      // -----------------------
      // Marker
      // -----------------------
      if (!markers[imei]) {
        markers[imei] = L.marker([lat, lon], {
          icon: getIcon(speed)
        }).addTo(map)
          .bindPopup(`<b>${imei}</b><br>Speed: ${speed} km/h`);
      } else {
        markers[imei]
          .setLatLng([lat, lon])
          .setIcon(getIcon(speed))
          .setPopupContent(`<b>${imei}</b><br>Speed: ${speed} km/h`);
      }

      // -----------------------
      // Trail
      // -----------------------
      if (trails[imei]) {
        map.removeLayer(trails[imei]);
      }

      if (trail && trail.length > 1) {
        const latlngs = trail.map(p => [p.lat, p.lon]);
        trails[imei] = L.polyline(latlngs, {
          color: "blue",
          weight: 3,
          opacity: 0.6
        }).addTo(map);
      }
    });
  }

  // -----------------------
  // Search / Filter
  // -----------------------
  document.getElementById("filter").addEventListener("input", e => {
    const value = e.target.value.toLowerCase();
    document.querySelectorAll("#deviceTable tbody tr").forEach(row => {
      row.style.display = row.dataset.imei.toLowerCase().includes(value)
        ? ""
        : "none";
    });
  });

  // -----------------------
  // Auto refresh
  // -----------------------
  fetchDevices();
  setInterval(fetchDevices, 10000);
</script>

</body>
</html>
